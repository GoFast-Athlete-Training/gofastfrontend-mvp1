# Garmin OAuth 1.0a Integration Documentation

## Overview
This document outlines the complete Garmin OAuth 1.0a integration for GoFast MVP1, including frontend components, backend endpoints, and configuration procedures.

## Architecture

### Frontend (React/Vite)
- **Domain**: `https://athlete.gofastcrushgoals.com`
- **Logo URL**: `https://athlete.gofastcrushgoals.com/logo.jpg`

### Backend (Node.js/Express)
- **Domain**: `https://gofastbackendv2-fall2025.onrender.com`
- **Environment Variables**: `GARMIN_CONSUMER_KEY`, `GARMIN_CONSUMER_SECRET`

## OAuth 1.0a Flow

### Step 1: OAuth Initiation
**Frontend Route**: `/garmin/connect` → `GarminConnect` component
**Backend Endpoint**: `POST /api/garmin/auth`

**Request Body**:
```json
{
  "callback_url": "https://athlete.gofastcrushgoals.com/garmin/callback"
}
```

**Backend Process**:
1. Generates OAuth 1.0a signature using consumer key/secret
2. Requests temporary token from Garmin
3. Returns authorization URL

**Response**:
```json
{
  "success": true,
  "authUrl": "https://connect.garmin.com/oauthConfirm?oauth_token=TEMP_TOKEN"
}
```

### Step 2: User Authorization
1. User redirected to Garmin authorization page
2. User logs in and clicks "I Accept"
3. Garmin redirects to callback URL

### Step 3: OAuth Callback
**Frontend Route**: `/garmin/callback` → `GarminOAuthCallback` component
**Garmin Redirect**: `https://athlete.gofastcrushgoals.com/garmin/callback?oauth_token=TEMP_TOKEN&oauth_verifier=VERIFIER`

**Frontend Process**:
1. Extracts `oauth_token` and `oauth_verifier` from URL
2. Sends to backend for token exchange

**Backend Endpoint**: `POST /api/garmin/callback`

**Request Body**:
```json
{
  "oauth_token": "TEMP_TOKEN",
  "oauth_verifier": "VERIFIER_CODE"
}
```

**Backend Process**:
1. Exchanges verifier for permanent access tokens
2. Stores tokens in database
3. Updates user's Garmin connection status

### Step 4: Success
User redirected to settings page with success message.

## Configuration

### Garmin Developer Portal Setup
1. **OAuth Redirect URL**: `https://athlete.gofastcrushgoals.com/garmin/callback`
2. **Logo URL**: `https://athlete.gofastcrushgoals.com/logo.jpg`
3. **Consumer Key**: Generated by Garmin
4. **Consumer Secret**: Generated by Garmin

### Environment Variables (Render)
```
GARMIN_CONSUMER_KEY=your_consumer_key_here
GARMIN_CONSUMER_SECRET=your_consumer_secret_here
```

### Frontend Configuration
**File**: `src/config/garminConfig.js`
```javascript
export const GARMIN_CONFIG = {
  CONSUMER_KEY: process.env.REACT_APP_GARMIN_CONSUMER_KEY,
  CONSUMER_SECRET: process.env.REACT_APP_GARMIN_CONSUMER_SECRET,
  CALLBACK_URL: 'https://athlete.gofastcrushgoals.com/garmin/callback',
  REQUEST_TOKEN_URL: 'https://connectapi.garmin.com/oauth-service/oauth/request_token',
  ACCESS_TOKEN_URL: 'https://connectapi.garmin.com/oauth-service/oauth/access_token',
  AUTHORIZE_URL: 'https://connect.garmin.com/oauthConfirm',
  API_BASE_URL: 'https://gofastbackendv2-fall2025.onrender.com/api'
};
```

## Database Schema

### Required Fields (Add to Athlete table)
```sql
ALTER TABLE athlete ADD COLUMN oauth_token VARCHAR(255);
ALTER TABLE athlete ADD COLUMN oauth_token_secret VARCHAR(255);
ALTER TABLE athlete ADD COLUMN garmin_connected BOOLEAN DEFAULT FALSE;
ALTER TABLE athlete ADD COLUMN garmin_user_id VARCHAR(255);
```

## API Endpoints

### Backend Routes
- `POST /api/garmin/auth` - Initiate OAuth flow
- `POST /api/garmin/callback` - Exchange verifier for tokens

### Frontend Routes
- `/garmin/connect` - OAuth initiation page
- `/garmin/callback` - OAuth callback handler

## Testing Procedure

### 1. Configure Garmin Portal
- Set OAuth redirect URL to: `https://athlete.gofastcrushgoals.com/garmin/callback`
- Upload logo from: `https://athlete.gofastcrushgoals.com/logo.jpg`
- Note consumer key and secret

### 2. Update Environment Variables
- Add `GARMIN_CONSUMER_KEY` and `GARMIN_CONSUMER_SECRET` to Render

### 3. Test OAuth Flow
1. Navigate to Settings page
2. Click "Connect Garmin"
3. Complete Garmin authorization
4. Verify success redirect to settings

### 4. Verify Token Storage
- Check database for stored OAuth tokens
- Confirm `garmin_connected` status updated

## Error Handling

### Common Issues
1. **Invalid callback URL** - Ensure Garmin portal matches frontend route
2. **Missing environment variables** - Verify Render env vars are set
3. **OAuth signature errors** - Check consumer key/secret configuration
4. **Token exchange failures** - Verify temporary token storage

### Debug Steps
1. Check browser console for frontend errors
2. Check backend logs for OAuth signature issues
3. Verify Garmin portal configuration
4. Test with Garmin's OAuth testing tools

## Security Considerations

1. **Consumer Secret** - Never expose in frontend code
2. **Token Storage** - Encrypt OAuth tokens in database
3. **HTTPS Only** - All OAuth URLs must use HTTPS
4. **Token Rotation** - Implement token refresh if needed

## Next Steps

1. **Database Migration** - Add Garmin token fields to athlete table
2. **Token Management** - Implement secure token storage/retrieval
3. **Activity Sync** - Use stored tokens to fetch user activities
4. **Webhook Integration** - Connect with existing Garmin webhook service

## Support Resources

- **Garmin Developer Portal**: https://developerportal.garmin.com/
- **OAuth 1.0a Specification**: RFC 5849
- **Garmin Connect API**: https://developer.garmin.com/gc-developer-program/
